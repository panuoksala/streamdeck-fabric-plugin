name: Build and Package Stream Deck Plugin

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.0.5)'
        required: true
        default: '0.0.5'

jobs:
  build-and-package:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Update version in manifest.json
      run: |
        # Get version from tag or input
        $version = "${{ github.event.inputs.version }}"
        if ([string]::IsNullOrEmpty($version)) {
          $version = "${{ github.ref_name }}".TrimStart('v')
        }
        
        # Add .0 at the end to match the format x.x.x.0
        $manifestVersion = "$version.0"
        
        Write-Host "Updating manifest.json with version: $manifestVersion"
        
        # Read manifest.json
        $manifestPath = "manifest.json"
        $manifest = Get-Content $manifestPath -Raw | ConvertFrom-Json
        
        # Update version
        $manifest.Version = $manifestVersion
        
        # Write back to file
        $manifest | ConvertTo-Json -Depth 10 | Set-Content $manifestPath
        
        Write-Host "manifest.json updated successfully"
        Write-Host "New version: $($manifest.Version)"
      shell: pwsh
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
    
    - name: Install Stream Deck CLI
      run: |
        # Download and install Stream Deck CLI
        $cliUrl = "https://github.com/elgatosf/cli/releases/latest/download/streamdeck-cli-windows-x64.zip"
        $cliPath = "${{ runner.temp }}\streamdeck-cli"
        
        Write-Host "Downloading Stream Deck CLI..."
        Invoke-WebRequest -Uri $cliUrl -OutFile "${{ runner.temp }}\streamdeck-cli.zip"
        
        Write-Host "Extracting Stream Deck CLI..."
        Expand-Archive -Path "${{ runner.temp }}\streamdeck-cli.zip" -DestinationPath $cliPath -Force
        
        # Add to PATH
        echo "$cliPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        
        # Verify installation
        & "$cliPath\streamdeck.exe" --version
      shell: pwsh
    
    - name: Restore dependencies
      run: dotnet restore StreamDeckMicrosoftFabric.sln
    
    - name: Build for Windows
      run: |
        dotnet build StreamDeckMicrosoftFabric.sln --configuration Release --runtime win-x64 --no-restore
        dotnet publish StreamDeckMicrosoftFabric.csproj --configuration Release --runtime win-x64 --no-build --output ./publish/win-x64
    
    - name: Build for macOS
      run: |
        dotnet build StreamDeckMicrosoftFabric.sln --configuration Release --runtime osx-x64 --no-restore
        dotnet publish StreamDeckMicrosoftFabric.csproj --configuration Release --runtime osx-x64 --no-build --output ./publish/osx-x64
    
    - name: Prepare plugin structure
      run: |
        # Create plugin directory structure
        $pluginDir = "net.fabricdeck.microsoftfabric.sdPlugin"
        New-Item -ItemType Directory -Force -Path $pluginDir
        
        # Copy Windows build
        New-Item -ItemType Directory -Force -Path "$pluginDir\win"
        Copy-Item -Path ".\publish\win-x64\*" -Destination "$pluginDir\win" -Recurse -Force
        
        # Copy macOS build
        New-Item -ItemType Directory -Force -Path "$pluginDir\mac"
        Copy-Item -Path ".\publish\osx-x64\*" -Destination "$pluginDir\mac" -Recurse -Force
        
        # Copy manifest and other required files to root
        Copy-Item -Path "manifest.json" -Destination $pluginDir -Force
        Copy-Item -Path "images" -Destination $pluginDir -Recurse -Force
        Copy-Item -Path "property_inspector" -Destination $pluginDir -Recurse -Force
        
        # Clean up unnecessary files
        Get-ChildItem -Path $pluginDir -Include "*.pdb", "*.xml", "*.deps.json", "*.runtimeconfig.json" -Recurse | Remove-Item -Force
        
        Write-Host "Plugin structure created successfully"
        Get-ChildItem -Path $pluginDir -Recurse | Select-Object FullName
      shell: pwsh
    
    - name: Package with Stream Deck CLI
      run: |
        # Get version from tag or input
        $version = "${{ github.event.inputs.version }}"
        if ([string]::IsNullOrEmpty($version)) {
          $version = "${{ github.ref_name }}".TrimStart('v')
        }
        
        Write-Host "Packaging plugin version: $version"
        
        # Run streamdeck pack command
        $cliPath = "${{ runner.temp }}\streamdeck-cli"
        & "$cliPath\streamdeck.exe" pack net.fabricdeck.microsoftfabric.sdPlugin --output "FabricDeck-$version.streamDeckPlugin"
        
        # Verify the package was created
        if (Test-Path "FabricDeck-$version.streamDeckPlugin") {
          Write-Host "Plugin package created successfully: FabricDeck-$version.streamDeckPlugin"
          $fileInfo = Get-Item "FabricDeck-$version.streamDeckPlugin"
          Write-Host "File size: $($fileInfo.Length / 1MB) MB"
        } else {
          Write-Error "Failed to create plugin package"
          exit 1
        }
      shell: pwsh
    
    - name: Upload plugin package
      uses: actions/upload-artifact@v4
      with:
        name: streamdeck-plugin
        path: FabricDeck-*.streamDeckPlugin
        retention-days: 30
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: FabricDeck-*.streamDeckPlugin
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-package-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Update version in manifest.json (macOS)
      run: |
        # Get version from tag or input
        VERSION="${{ github.event.inputs.version }}"
        if [ -z "$VERSION" ]; then
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
        fi
        
        # Add .0 at the end to match the format x.x.x.0
        MANIFEST_VERSION="${VERSION}.0"
        
        echo "Updating manifest.json with version: $MANIFEST_VERSION"
        
        # Update version in manifest.json using sed (macOS compatible)
        sed -i '' "s/\"Version\": \"[^\"]*\"/\"Version\": \"$MANIFEST_VERSION\"/" manifest.json
        
        echo "manifest.json updated successfully"
        echo "New version:"
        grep "Version" manifest.json
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
    
    - name: Install Stream Deck CLI
      run: |
        # Download and install Stream Deck CLI for macOS
        CLI_URL="https://github.com/elgatosf/cli/releases/latest/download/streamdeck-cli-macos-universal.zip"
        CLI_PATH="${{ runner.temp }}/streamdeck-cli"
        
        echo "Downloading Stream Deck CLI..."
        curl -L -o "${{ runner.temp }}/streamdeck-cli.zip" "$CLI_URL"
        
        echo "Extracting Stream Deck CLI..."
        unzip -o "${{ runner.temp }}/streamdeck-cli.zip" -d "$CLI_PATH"
        
        # Make executable
        chmod +x "$CLI_PATH/streamdeck"
        
        # Add to PATH
        echo "$CLI_PATH" >> $GITHUB_PATH
        
        # Verify installation
        "$CLI_PATH/streamdeck" --version
    
    - name: Build for macOS (native)
      run: |
        dotnet restore StreamDeckMicrosoftFabric.sln
        dotnet build StreamDeckMicrosoftFabric.sln --configuration Release --runtime osx-x64
        dotnet publish StreamDeckMicrosoftFabric.csproj --configuration Release --runtime osx-x64 --no-build --output ./publish/osx-x64
    
    - name: Verify macOS build
      run: |
        # Create plugin directory structure for testing
        PLUGIN_DIR="net.fabricdeck.microsoftfabric.sdPlugin"
        mkdir -p "$PLUGIN_DIR/mac"
        
        # Copy macOS build
        cp -R ./publish/osx-x64/* "$PLUGIN_DIR/mac/"
        
        # Copy manifest and other required files
        cp manifest.json "$PLUGIN_DIR/"
        cp -R images "$PLUGIN_DIR/"
        cp -R property_inspector "$PLUGIN_DIR/"
        
        # List files to verify
        echo "Plugin structure:"
        find "$PLUGIN_DIR" -type f | head -20
        
        # Check if executable exists and is valid
        if [ -f "$PLUGIN_DIR/mac/StreamDeckMicrosoftFabric" ]; then
          echo "macOS executable found"
          file "$PLUGIN_DIR/mac/StreamDeckMicrosoftFabric"
        else
          echo "ERROR: macOS executable not found"
          exit 1
        fi
