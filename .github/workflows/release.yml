name: Build and Package Stream Deck Plugin

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.0.5)'
        required: true
        default: '0.0.5'

jobs:
  build-and-package:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Update version in manifest.json
      run: |
        # Get version from tag or input
        $version = "${{ github.event.inputs.version }}"
        if ([string]::IsNullOrEmpty($version)) {
          $version = "${{ github.ref_name }}".TrimStart('v')
        }
        
        # Add .0 at the end to match the format x.x.x.0
        $manifestVersion = "$version.0"
        
        Write-Host "Updating manifest.json with version: $manifestVersion"
        
        # Read manifest.json
        $manifestPath = "manifest.json"
        $manifest = Get-Content $manifestPath -Raw | ConvertFrom-Json
        
        # Update version
        $manifest.Version = $manifestVersion
        
        # Write back to file
        $manifest | ConvertTo-Json -Depth 10 | Set-Content $manifestPath
        
        Write-Host "manifest.json updated successfully"
        Write-Host "New version: $($manifest.Version)"
      shell: pwsh
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Stream Deck CLI
      run: |
        Write-Host "Installing Stream Deck CLI via npm..."
        npm install -g @elgato/cli@latest
        
        # Verify installation by checking if command exists
        Write-Host "Verifying Stream Deck CLI installation..."
        Get-Command streamdeck -ErrorAction Stop
        Write-Host "Stream Deck CLI installed successfully"
      shell: pwsh
    
    - name: Restore dependencies
      run: dotnet restore StreamDeckMicrosoftFabric.sln
    
    - name: Build for Windows
      run: |
        dotnet build StreamDeckMicrosoftFabric.sln --configuration Release --runtime win-x64 --no-restore
        dotnet publish StreamDeckMicrosoftFabric.csproj --configuration Release --runtime win-x64 --no-build --output ./publish/win-x64
    
    - name: Build for macOS
      run: |
        dotnet build StreamDeckMicrosoftFabric.sln --configuration Release --runtime osx-x64 --no-restore
        dotnet publish StreamDeckMicrosoftFabric.csproj --configuration Release --runtime osx-x64 --no-build --output ./publish/osx-x64
    
    - name: Prepare plugin structure
      run: |
        # Create plugin directory structure
        $pluginDir = "net.fabricdeck.microsoftfabric.sdPlugin"
        New-Item -ItemType Directory -Force -Path $pluginDir
        
        # Copy Windows build
        New-Item -ItemType Directory -Force -Path "$pluginDir\win"
        Copy-Item -Path ".\publish\win-x64\*" -Destination "$pluginDir\win" -Recurse -Force
        
        # Copy macOS build
        New-Item -ItemType Directory -Force -Path "$pluginDir\mac"
        Copy-Item -Path ".\publish\osx-x64\*" -Destination "$pluginDir\mac" -Recurse -Force
        
        # Copy manifest and other required files to root
        Copy-Item -Path "manifest.json" -Destination $pluginDir -Force
        Copy-Item -Path "images" -Destination $pluginDir -Recurse -Force
        Copy-Item -Path "property_inspector" -Destination $pluginDir -Recurse -Force
        
        # Clean up unnecessary files
        Get-ChildItem -Path $pluginDir -Include "*.pdb", "*.xml", "*.deps.json", "*.runtimeconfig.json" -Recurse | Remove-Item -Force
        
        Write-Host "Plugin structure created successfully"
        Get-ChildItem -Path $pluginDir -Recurse | Select-Object FullName
      shell: pwsh
    
    - name: Package with Stream Deck CLI
      run: |
        # Get version from tag or input
        $version = "${{ github.event.inputs.version }}"
        if ([string]::IsNullOrEmpty($version)) {
          $version = "${{ github.ref_name }}".TrimStart('v')
        }
        
        Write-Host "Packaging plugin version: $version"
        
        # Run streamdeck pack command
        streamdeck pack net.fabricdeck.microsoftfabric.sdPlugin --output "FabricDeck-$version.streamDeckPlugin"
        
        # Verify the package was created
        if (Test-Path "FabricDeck-$version.streamDeckPlugin") {
          Write-Host "Plugin package created successfully: FabricDeck-$version.streamDeckPlugin"
          $fileInfo = Get-Item "FabricDeck-$version.streamDeckPlugin"
          Write-Host "File size: $($fileInfo.Length / 1MB) MB"
        } else {
          Write-Error "Failed to create plugin package"
          exit 1
        }
      shell: pwsh
    
    - name: Upload plugin package
      uses: actions/upload-artifact@v4
      with:
        name: streamdeck-plugin
        path: FabricDeck-*.streamDeckPlugin
        retention-days: 30
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: FabricDeck-*.streamDeckPlugin
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

